#!/usr/bin/env bash
#
# handy-to-tmux: Watches Handy's history DB for new transcriptions
# and sends them to a tmux session.
#
# Usage:
#   handy-to-tmux start            — start the watcher in the background
#   handy-to-tmux stop             — stop the watcher
#   handy-to-tmux status           — check if the watcher is running
#   handy-to-tmux run              — run in foreground (for debugging)
#   handy-to-tmux target <session> — set target tmux session and start recording
#

set -euo pipefail

DB="$HOME/.local/share/com.pais.handy/history.db"
DEFAULT_SESSION="handy"
STATEDIR="$HOME/.local/state"
PIDFILE="$STATEDIR/handy-to-tmux.pid"
LOGFILE="$STATEDIR/handy-to-tmux.log"
TARGETFILE="$STATEDIR/handy-to-tmux.target"
RECORDINGFILE="$STATEDIR/handy-to-tmux.recording"
POLL_INTERVAL=0.3

mkdir -p "$STATEDIR"

is_running() {
    [[ -f "$PIDFILE" ]] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null
}

do_stop() {
    if is_running; then
        local pid
        pid=$(cat "$PIDFILE")
        kill "$pid" 2>/dev/null
        rm -f "$PIDFILE" "$RECORDINGFILE"
        echo "handy-to-tmux: stopped (pid $pid)"
    else
        rm -f "$PIDFILE" "$RECORDINGFILE"
        echo "handy-to-tmux: not running"
    fi
}

do_status() {
    if is_running; then
        local target recording_status
        target=$(cat "$TARGETFILE" 2>/dev/null || echo "$DEFAULT_SESSION")
        if [[ -f "$RECORDINGFILE" ]]; then
            recording_status="recording"
        else
            recording_status="idle"
        fi
        echo "handy-to-tmux: running (pid $(cat "$PIDFILE"), target=$target, $recording_status)"
    else
        rm -f "$PIDFILE"
        echo "handy-to-tmux: not running"
    fi
}

get_target() {
    if [[ -f "$TARGETFILE" ]]; then
        cat "$TARGETFILE"
    else
        echo "$DEFAULT_SESSION"
    fi
}

do_target() {
    local session="${1:-}"
    if [[ -z "$session" ]]; then
        echo "Usage: handy-to-tmux target <session-name>" >&2
        exit 1
    fi

    # If already recording to this session, stop recording instead
    if [[ -f "$RECORDINGFILE" ]] && [[ "$(cat "$TARGETFILE" 2>/dev/null)" == "$session" ]]; then
        xdotool key ctrl+space
        rm -f "$RECORDINGFILE"
        echo "handy-to-tmux: stopped recording (target '$session')"
        return 0
    fi

    # Trigger Handy's transcribe shortcut first, then do bookkeeping
    xdotool key ctrl+space

    if ! tmux has-session -t "$session" 2>/dev/null; then
        echo "handy-to-tmux: warning: tmux session '$session' does not exist" >&2
    fi

    echo "$session" > "$TARGETFILE"
    touch "$RECORDINGFILE"
    echo "handy-to-tmux: recording to '$session'"
}

do_watch() {
    if [[ ! -f "$DB" ]]; then
        echo "Error: Handy database not found at $DB" >&2
        exit 1
    fi

    local last_id
    last_id=$(sqlite3 "$DB" "SELECT COALESCE(MAX(id), 0) FROM transcription_history;")
    echo "handy-to-tmux: watching (last_id=$last_id, default_target=$DEFAULT_SESSION)"

    while true; do
        sleep "$POLL_INTERVAL"

        local target
        target=$(get_target)

        while IFS='|' read -r id text; do
            [[ -z "$id" ]] && continue
            last_id="$id"
            if tmux has-session -t "$target" 2>/dev/null; then
                echo "handy-to-tmux: [$target] $text"
                tmux send-keys -t "$target" -l "$text"
                local submit_key="Enter"
                local pane_tty
                pane_tty=$(tmux display-message -p -t "$target" "#{pane_tty}" 2>/dev/null || true)

                # Codex in tmux treats Enter from send-keys as a literal newline.
                # Sending Tab queues/submits the message in Codex's composer.
                if [[ -n "$pane_tty" ]] && ps -t "${pane_tty#/dev/}" -o comm= 2>/dev/null | grep -qx "codex"; then
                    submit_key="Tab"
                fi

                tmux send-keys -t "$target" "$submit_key"
            fi
        done < <(sqlite3 "$DB" "SELECT id, transcription_text FROM transcription_history WHERE id > $last_id ORDER BY id ASC;")
    done
}

do_start() {
    if is_running; then
        echo "handy-to-tmux: already running (pid $(cat "$PIDFILE"))"
        return 0
    fi

    nohup "$0" run >> "$LOGFILE" 2>&1 &
    local pid=$!
    echo "$pid" > "$PIDFILE"
    echo "handy-to-tmux: started (pid $pid, log $LOGFILE)"
}

case "${1:-start}" in
    start)  do_start  ;;
    stop)   do_stop   ;;
    status) do_status ;;
    run)    do_watch  ;;
    target) do_target "${2:-}" ;;
    *)
        echo "Usage: handy-to-tmux {start|stop|status|target <session>|run}" >&2
        exit 1
        ;;
esac
